/************************************************
文件：TWI.c
用途：TWI操作函数
************************************************/
#include "config.h"

/*************************************************************************
** 函数名称: twi_init(void)
** 功能描述: i2c通信初始化
** 输　入: bit rate = 32
** 输出	 : SCL rate = 100KHz
** 全局变量: 无
** 调用模块: 
** 说明：
** 注意：
**************************************************************************/
void twi_init(void)
{
	TWCR = 0x00; 		//disable twi
	TWBR = 0x20; 		//set bit rate
	TWSR = 0x00; 		//set prescale
	TWAR = 0x00; 		//set slave address
	TWCR = (1<<TWEN); 	//enable twi
}
/*************************************************************************
** 函数名称: i2c_start(void)
** 功能描述: i2c通信开始
** 输　入: 
** 输出	 : 
** 全局变量: 无
** 调用模块: 
** 说明：
** 注意：
**************************************************************************/
void i2c_start(void)
{ 
	TWCR = (1<<TWINT) | (1<<TWSTA) | (1<<TWEN); 
	while (!(TWCR & (1<<TWINT)));
}
/*************************************************************************
** 函数名称: unsigned char i2c_write(unsigned char data)
** 功能描述: i2c写数据,返回TWI状态
** 输　入: 
** 输  出: TWI状态
** 全局变量: 无
** 调用模块: 
** 说明：
** 注意：
**************************************************************************/
unsigned char i2c_write(unsigned char data)
{ 
	TWDR = data;
	TWCR = (1<<TWINT) | (1<<TWEN);
	while (!(TWCR & (1<<TWINT)));
	_NOP();
	return(TWSR & 0b11111000);
}
/*************************************************************************
** 函数名称: unsigned char i2c_read(void)
** 功能描述: i2c读数据
** 输　入: 
** 输出	 : 读取的数据
** 全局变量: 无
** 调用模块: 
** 说明：
** 注意：
**************************************************************************/
unsigned char i2c_read(void)
{
	TWCR= (1<<TWINT) | (1<<TWEA) | (1<<TWEN);
	while (!(TWCR & (1<<TWINT)));
	return(TWDR);
}
/*************************************************************************
** 函数名称: i2c_stop(void)
** 功能描述: i2c停止
** 输　入: 
** 输出	 : 
** 全局变量: 无
** 调用模块: 
** 说明：
** 注意：
**************************************************************************/
void i2c_stop(void)
{ 
	TWCR = (1<<TWINT) | (1<<TWSTO) | (1<<TWEN);//写1清0
}
